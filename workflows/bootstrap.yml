description: Bootstrap workflow for MeroSign e-signature platform
name: MeroSign Bootstrap Workflow

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: merosign-node

steps:
  # Step 1: Install the MeroSign application on the first node
  - name: Install MeroSign Application on Node 1
    type: install_application
    node: merosign-node-1
    path: "logic/res/mero_sign.wasm"
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Install application on other nodes
  - name: Install MeroSign Application on Node 2
    type: install_application
    node: merosign-node-2
    path: "logic/res/mero_sign.wasm"
    dev: true

  # Step 3: Generate identities on all nodes
  - name: Create Identity on Node 1
    type: create_identity
    node: merosign-node-1
    outputs:
      node1_public_key: publicKey

  - name: Create Identity on Node 2
    type: create_identity
    node: merosign-node-2
    outputs:
      node2_public_key: publicKey

  # Step 4: Wait for identities to be created
  - name: Wait for Identity Creation
    type: wait
    seconds: 5

  # Step 5: Create default context (user's private workspace) on Node 1
  - name: Create Default Context on Node 1
    type: create_context
    node: merosign-node-1
    application_id: "{{app_id}}"
    params: '{"is_private": true, "context_name": "default"}'
    outputs:
      default_context_id: contextId
      admin_public_key: memberPublicKey

  # Step 6: Create default contexts on other nodes
  - name: Create Default Context on Node 2
    type: create_context
    node: merosign-node-2
    application_id: "{{app_id}}"
    params: '{"is_private": true, "context_name": "default"}'

  # Step 7: Wait for default contexts to sync
  - name: Wait for Default Context Sync
    type: wait
    seconds: 3

  # Step 8: Create a shared agreement context from Node 1 (Admin)
  - name: Create Agreement Context from Node 1
    type: create_context
    node: merosign-node-1
    application_id: "{{app_id}}"
    params: '{"is_private": false, "context_name": "contract_agreement_001"}'
    outputs:
      agreement_context_id: contextId # Export 'contextId' as 'agreement_context_id'
      agreement_admin_key: memberPublicKey # Export 'memberPublicKey' as 'agreement_admin_key'

  # Step 9: Create open invitation for the agreement context
  - name: Create Open Invitation for Agreement
    type: invite_open
    node: merosign-node-1
    context_id: "{{agreement_context_id}}"
    granter_id: "{{agreement_admin_key}}"
    valid_for_blocks: 1000
    outputs:
      open_invitation: invitation

  # Step 10: Join agreement from Node 2 using open invitation
  - name: Join Agreement from Node 2 via Open Invitation
    type: join_open
    node: merosign-node-2
    invitee_id: "{{node2_public_key}}"
    invitation: "{{open_invitation}}"
    outputs:
      joined_context_id_2: contextId
      joined_member_key_2: memberPublicKey

  # Step 12: Wait for context synchronization
  - name: Wait for Agreement Context Sync
    type: wait_for_sync
    context_id: "{{agreement_context_id}}"
    nodes:
      - merosign-node-1
      - merosign-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Step 14: Add participants to the shared context with permissions
  - name: Add Node 2 as Participant with Sign Permission
    type: call
    node: merosign-node-1
    context_id: "{{agreement_context_id}}"
    executor_public_key: "{{agreement_admin_key}}"
    method: add_participant
    args:
      user_id: "{{node2_public_key}}"
      permission: "Sign"

  # Step 15: Wait for participant addition to sync
  - name: Wait for Participant Addition Sync
    type: wait_for_sync
    context_id: "{{agreement_context_id}}"
    nodes:
      - merosign-node-1
      - merosign-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Step 16: List participants from Node 2
  - name: List Participants from Node 2
    type: call
    node: merosign-node-2
    context_id: "{{agreement_context_id}}"
    executor_public_key: "{{node2_public_key}}"
    method: list_participants

  # Step 17: Get context details from Node 1
  - name: Get Context Details from Node 1
    type: call
    node: merosign-node-1
    context_id: "{{agreement_context_id}}"
    executor_public_key: "{{agreement_admin_key}}"
    method: get_context_details
    args:
      context_id: "{{agreement_context_id}}"

# Configuration options
auth_service: true
stop_all_nodes: true
force_pull_image: true
restart: false
wait_timeout: 120
